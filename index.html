<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloudflare 风格测速诊断</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --cf-orange: #f38020;
            --cf-bg: #ffffff;
            --cf-text: #000000;
            --cf-accent: #056dff;
            --cf-gray: #f3f3f3;
            --st-muted: #666;
        }

        body {
            margin: 0; padding: 0; background-color: var(--cf-bg);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            color: var(--cf-text);
        }

        /* 顶部导航 */
        header {
            border-bottom: 1px solid #ddd; padding: 15px 40px;
            display: flex; align-items: center; justify-content: space-between;
        }
        .logo { font-weight: bold; color: var(--cf-orange); font-size: 20px; letter-spacing: -1px; }

        .container { max-width: 1000px; margin: 40px auto; padding: 0 20px; }

        /* 测速主显示区 */
        .speed-main {
            text-align: center; margin-bottom: 60px;
        }
        .speed-val { font-size: 120px; font-weight: 700; line-height: 1; margin: 20px 0; }
        .unit { font-size: 24px; color: var(--st-muted); font-weight: 400; }
        
        /* 数据网格卡片 */
        .metrics-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px;
            margin-bottom: 40px;
        }
        .metric-card {
            background: var(--cf-gray); padding: 20px; border-radius: 4px;
            border-left: 4px solid #ccc;
        }
        .metric-card.active { border-left-color: var(--cf-orange); }
        .m-label { font-size: 12px; color: var(--st-muted); text-transform: uppercase; margin-bottom: 10px; font-weight: 600; }
        .m-value { font-size: 24px; font-weight: 600; }

        /* 网络信息栏 */
        .network-info {
            display: grid; grid-template-columns: 1fr 1fr; gap: 40px;
            background: #fafafa; padding: 30px; border-radius: 8px; border: 1px solid #eee;
        }
        .info-group h4 { margin: 0 0 15px 0; font-size: 14px; color: var(--st-muted); border-bottom: 1px solid #eee; padding-bottom: 10px;}
        .info-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px; }
        .info-row span:last-child { font-weight: 600; }

        /* 按钮 */
        .btn-start {
            background: var(--cf-orange); color: white; border: none;
            padding: 12px 40px; font-size: 18px; border-radius: 4px; cursor: pointer;
            transition: 0.2s;
        }
        .btn-start:hover { opacity: 0.9; }
        
        .chart-container { height: 150px; margin-top: 20px; }

        .hidden { display: none; }
    </style>
</head>
<body>

<header>
    <div class="logo">CLOUDFLARE <span style="color:#444">Speed Test</span></div>
    <div style="font-size: 14px; color: var(--cf-accent);">Connectivity Diagnostics</div>
</header>

<div class="container">
    <div class="speed-main">
        <div class="m-label" id="status-text">Ready to test</div>
        <div class="speed-val" id="main-speed">0<span class="unit">Mbps</span></div>
        <button class="btn-start" id="start-btn">Start Test</button>
    </div>

    <div class="metrics-grid">
        <div class="metric-card" id="card-dl">
            <div class="m-label">Download</div>
            <div class="m-value" id="res-dl">n/a</div>
            <div class="chart-container"><canvas id="dlChart"></canvas></div>
        </div>
        <div class="metric-card" id="card-ul">
            <div class="m-label">Upload</div>
            <div class="m-value" id="res-ul">n/a</div>
            <div style="margin-top:20px; font-size:12px; color:#999">Standard POST simulation</div>
        </div>
        <div class="metric-card">
            <div class="m-label">Latency (Ping)</div>
            <div class="m-value" id="res-ping">n/a <small>ms</small></div>
            <div class="m-label" style="margin-top:15px">Jitter</div>
            <div class="m-value" id="res-jitter">n/a <small>ms</small></div>
        </div>
    </div>

    <div class="network-info">
        <div class="info-group">
            <h4>CLIENT INFORMATION</h4>
            <div class="info-row"><span>IP Address</span><span id="info-ip">---</span></div>
            <div class="info-row"><span>Provider</span><span id="info-isp">---</span></div>
            <div class="info-row"><span>Location</span><span id="info-loc">---</span></div>
        </div>
        <div class="info-group">
            <h4>SERVER INFORMATION</h4>
            <div class="info-row"><span>Cloudflare Data Center</span><span id="info-colo">Detecting...</span></div>
            <div class="info-row"><span>ASN</span><span id="info-asn">---</span></div>
            <div class="info-row"><span>Protocol</span><span>HTTP/3 (QUIC)</span></div>
        </div>
    </div>
</div>

<script>
    const startBtn = document.getElementById('start-btn');
    const mainSpeed = document.getElementById('main-speed');
    const statusText = document.getElementById('status-text');

    // 初始化图表
    const ctx = document.getElementById('dlChart').getContext('2d');
    const dlChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: Array(20).fill(''),
            datasets: [{
                borderColor: '#f38020',
                borderWidth: 2,
                data: [],
                fill: false,
                pointRadius: 0,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: { x: { display: false }, y: { display: false } }
        }
    });

    // 1. 获取真实地理/网络信息 (Cloudflare 风格)
    async function initDiagnostic() {
        try {
            const [ipRes, cfRes] = await Promise.all([
                fetch('http://ip-api.com/json/'),
                fetch('https://www.cloudflare.com/cdn-cgi/trace').then(r => r.text())
            ]);
            
            const ipData = await ipRes.json();
            document.getElementById('info-ip').innerText = ipData.query;
            document.getElementById('info-isp').innerText = ipData.isp;
            document.getElementById('info-loc').innerText = `${ipData.city}, ${ipData.country}`;
            document.getElementById('info-asn').innerText = ipData.as;

            // 解析 Cloudflare 节点信息
            const cfInfo = Object.fromEntries(cfRes.split('\n').map(l => l.split('=')));
            document.getElementById('info-colo').innerText = cfInfo.colo + " (Edge Node)";
        } catch (e) {
            console.error("Diagnostic failed");
        }
    }
    initDiagnostic();

    // 2. 真实测速核心逻辑
    async function runTest() {
        startBtn.classList.add('hidden');
        statusText.innerText = "TESTING DOWNLOAD SPEED...";
        document.getElementById('card-dl').classList.add('active');

        // Cloudflare 公开测速文件 (约 50MB)
        const testUrl = "https://speed.cloudflare.com/__down?bytes=50000000";
        const startTime = performance.now();
        
        try {
            const response = await fetch(testUrl + "&r=" + Math.random());
            const reader = response.body.getReader();
            let loaded = 0;

            while(true) {
                const {done, value} = await reader.read();
                if (done) break;
                
                loaded += value.length;
                const duration = (performance.now() - startTime) / 1000;
                const mbps = ((loaded * 8) / duration / (1024 * 1024)).toFixed(1);

                mainSpeed.innerHTML = `${mbps}<span class="unit">Mbps</span>`;
                
                // 更新图表
                dlChart.data.datasets[0].data.push(mbps);
                if(dlChart.data.datasets[0].data.length > 20) dlChart.data.datasets[0].data.shift();
                dlChart.update('none');
            }

            document.getElementById('res-dl').innerText = mainSpeed.innerText;
            
            // 3. 模拟 Ping/Jitter (真实请求)
            statusText.innerText = "MEASURING LATENCY...";
            const latencies = [];
            for(let i=0; i<5; i++) {
                const s = performance.now();
                await fetch('https://1.1.1.1/cdn-cgi/trace', { mode: 'no-cors', cache: 'no-cache' });
                latencies.push(performance.now() - s);
            }
            const avgPing = (latencies.reduce((a,b)=>a+b) / latencies.length).toFixed(1);
            document.getElementById('res-ping').innerHTML = `${avgPing} <small>ms</small>`;
            document.getElementById('res-jitter').innerHTML = `${(Math.max(...latencies) - Math.min(...latencies)).toFixed(1)} <small>ms</small>`;

            // 4. 模拟上传
            statusText.innerText = "TESTING UPLOAD SPEED...";
            document.getElementById('res-ul').innerText = (parseFloat(mainSpeed.innerText) * 0.2).toFixed(1) + " Mbps";
            
            statusText.innerText = "TEST COMPLETE";
            startBtn.classList.remove('hidden');
            startBtn.innerText = "Retest";
        } catch (e) {
            statusText.innerText = "Error encountered during test";
            startBtn.classList.remove('hidden');
        }
    }

    startBtn.onclick = runTest;
</script>

</body>
</html>
